//+------------------------------------------------------------------+
//|                                        RSISniper_Fixed_v4.mq5     |
//|                                  Copyright 2026, AI Collaborator |
//+------------------------------------------------------------------+
#property strict
#include <Trade\Trade.mqh>

// --- Inputs ---
input int      InpRsiLength   = 14;          
input int      InpRsiOver     = 75;          // SELL
input int      InpRsiUnder    = 25;          // BUY
input double   InpLotSize     = 0.02;        // Matches your screenshot
input int      InpMagicNum    = 987654;      

// --- Globals ---
int      handleRSI;
CTrade   trade;
datetime lastBarTime = 0; // Ensures only one trade per candle

//+------------------------------------------------------------------+
int OnInit()
{
   // Use the official MT5 RSI handle - much more stable than manual math
   handleRSI = iRSI(_Symbol, _Period, InpRsiLength, PRICE_CLOSE);
   trade.SetExpertMagicNumber(InpMagicNum);
   return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
void OnTick()
{
   // 1. Check if a NEW bar has formed (M15)
   datetime currentBar = iTime(_Symbol, _Period, 0);
   if(currentBar == lastBarTime) return; // Wait for the next candle!

   // 2. Get the RSI value from the LAST CLOSED candle (Index 1)
   double rsiBuffer[];
   ArraySetAsSeries(rsiBuffer, true);
   if(CopyBuffer(handleRSI, 0, 1, 1, rsiBuffer) < 1) return;
   double rsiValue = rsiBuffer[0];

   // 3. Position Management: Check for existing trades
   ulong ticket = GetPositionTicket();
   
   // --- IF NO POSITION: LOOK FOR ENTRY ---
   if(ticket == 0) 
   {
      if(rsiValue < InpRsiUnder) {
         if(trade.Buy(InpLotSize, _Symbol)) {
            lastBarTime = currentBar; // Lock this candle
            SendNotification("ðŸš€ RSI Buy @ " + DoubleToString(rsiValue, 2));
         }
      }
      else if(rsiValue > InpRsiOver) {
         if(trade.Sell(InpLotSize, _Symbol)) {
            lastBarTime = currentBar; // Lock this candle
            SendNotification("ðŸ“‰ RSI Sell @ " + DoubleToString(rsiValue, 2));
         }
      }
   }
   // --- IF POSITION EXISTS: LOOK FOR EXIT (RSI 50) ---
   else 
   {
      if(PositionSelectByTicket(ticket)) {
         long type = PositionGetInteger(POSITION_TYPE);
         if((type == POSITION_TYPE_BUY && rsiValue >= 50) || 
            (type == POSITION_TYPE_SELL && rsiValue <= 50)) 
         {
            trade.PositionClose(ticket);
            SendNotification("âœ… Target Reached (RSI 50)");
         }
      }
   }
}

// Helper to find the specific ticket for THIS bot
ulong GetPositionTicket() {
   for(int i=PositionsTotal()-1; i>=0; i--) {
      ulong t = PositionGetTicket(i);
      if(PositionSelectByTicket(t))
         if(PositionGetInteger(POSITION_MAGIC) == InpMagicNum) return t;
   }
   return 0;
}
